<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Elearn project">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles/bootstrap4/bootstrap.min.css">
    <link href="plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/owl.carousel.css">
    <link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/owl.theme.default.css">
    <link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/animate.css">
    <link href="plugins/video-js/video-js.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="styles/main_styles.css">
    <link rel="stylesheet" href="styles/databasesTyp.css">
    <link rel="stylesheet" href="./styles/toast.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles/responsive.css">
    <!-- Toastr JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        .card-body {
            display: flex;
            flex-direction: column;
        }
        .card-bodyv {
            display: flex;
            flex-direction: column;
            min-width: 700px;
            min-height: 400px;
        }

        .lesson {
            flex: 1 1 calc(33.333% - 20px);
            /* Each lesson takes up one-third of the width */
            max-width: 300px;
            /* Maximum width for each lesson */
        }

        /* Highlight the current lesson */
        .current-lesson {
            background-color: #ffebcc;
            border: 2px solid #0E3D57;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        /* Start lesson button styling */
        .start-lesson {
            border-radius: 20px;
            background-color: #0E3D57;
            color: #fff;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }

        /* Locked lesson button styling */
        .btn-secondary {
            border-radius: 20px;
            padding: 10px 20px;
        }

        /* Styling for lesson content */
        .lessonContent {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .quizContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: #f9f9f9;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            font-family: 'Arial', sans-serif;
        }

        .quizQuestion {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .quizQuestion p {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .quizQuestion label {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 16px;
            color: #555;
            cursor: pointer;
        }

        .quizQuestion input[type="radio"] {
            margin-right: 10px;
        }

        .review-quiz {
            width: 150px;
            border: none;
            background-color: rgb(10, 152, 10);
            color: white;
            padding: 5px;
            cursor: pointer;
        }

        .quizContainer button {
            padding: 12px 20px;
            background-color: #0E3D57;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .quizContainer button:hover {
            background-color: #65A9C2;
        }

        .lessonContent {
            overflow-wrap: break-word;
            /* Allows long words to be broken and wrapped onto the next line */
            word-wrap: break-word;
            /* Ensures long words break to fit within their container */
            word-break: break-word;
            /* Breaks words at arbitrary points if they are too long */
            max-width: 100%;
            /* Ensures the content does not exceed the parent width */
            line-height: 1.5;
            /* Improves readability by adding space between lines */
        }

        .card {
            padding: 15px;
            /* Adds space inside the card */
            /* margin: 10px; */
            /* Adds space around the card */
            border: 1px solid #ddd;
            width: 100%;
            /* Adds a border around the card */
            border-radius: 10px;
            /* Rounds the corners of the card */
            background-color: #fff;
            /* Sets a background color for the card */
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .lesson {
                flex: 1 1 100%;
            }
        }

        @media (max-width: 768px) {
            .quizContainer {
                padding: 20px;
            }

            .quizQuestion {
                padding: 15px;
            }
        }

        #profileIcon:hover {
            color: #0E3D57;
        }

        #profileSection {
            transition: all 0.3s ease;
        }
    </style>

    <script type="module">
        import { auth, db } from './js/firebaseConfig.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js";
        import {
            doc,
            setDoc,
            updateDoc,
            getDoc,
            getDocs,
            collection,
            query,
            orderBy,
        } from 'https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js';

        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": false,
            "progressBar": true,
            "positionClass": "toast-top-center",
            "preventDuplicates": true,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "3000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        document.addEventListener('DOMContentLoaded', () => {

            // Function to extract the YouTube video ID from the URL
            function getYouTubeVideoId(url) {
                const videoIdMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?/);
                return videoIdMatch ? videoIdMatch[1] : null;
            }

            const myProgressButton = document.getElementById('myProgressButton');
            myProgressButton.addEventListener('click', function () {
                window.location.href = 'progress.html'
            });

            const hQuestion = document.getElementById('BtnQuestion');

            hQuestion.addEventListener('click', function () {
                window.location.href = 'contact.html';
            })

            const toggleAuthDisplay = (user) => {
                const authLinks = document.getElementById('authLinks');
                const profileIcon = document.getElementById('profileIcon');
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                const contactLink = document.querySelector('.main_nav a[href="contact.html"]');

                if (user) {
                    // Hide login/register links
                    authLinks.style.display = 'none';
                    // Show profile section
                    profileIcon.style.display = 'block';
                    // Display user's email
                    userEmail.textContent = user.email;

                    // Fetch user's custom data from Firestore
                    const userDocRef = doc(db, 'users', user.uid);
                    getDoc(userDocRef).then((docSnapshot) => {
                        if (docSnapshot.exists()) {
                            const userData = docSnapshot.data();
                            userName.textContent = 'Name : ' + userData.name || 'User'; // Display name or fallback to 'User'
                            userEmail.textContent = 'Email : ' + userData.email;
                            if (userData.role === 'admin') {
                                contactLink.textContent = 'Admin Panel'; // Change link text
                                contactLink.setAttribute('href', 'admin.html'); // Change href to admin page
                            }
                            else {
                                contactLink.textContent = 'Contact Us';
                            }

                        }
                    }).catch((error) => {
                        console.log('Error fetching user data:', error);
                        toastr.error('Error fetching user data');
                    });
                } else {
                    // Show login/register links
                    authLinks.style.display = 'block';
                    // Hide profile section
                    profileIcon.style.display = 'none';
                }
            };

            // Handle sign-out
            document.getElementById('signOutButton').addEventListener('click', () => {
                const profileContainer = document.getElementById('profileIcon');

                signOut(auth).then(() => {
                    console.log('User signed out');
                    toastr.success('User Signed Out Successfully');
                    profileIcon.style.display = "none";

                }).catch((error) => {
                    console.error('Error signing out:', error);
                    toastr.error('Error Signing Out Please Try Again!');
                });
            });

            // Profile icon toggle
            const profileIcon = document.getElementById('profileIcon');
            const profileSection = document.getElementById('profileSection');

            profileIcon.onclick = () => {
                profileSection.style.display = profileSection.style.display === 'block' ? 'none' : 'block';
            };

            ////////////////////////////////////////////////////////////////////////////////////
            onAuthStateChanged(auth, async (user) => {
                console.log('current user', user ? user.email : null);
                const profileIcon = document.getElementById('profileIcon');

                if (user) {
                    const userId = user.uid;

                    // Fetch user progress
                    const startCourseBtn = document.getElementById('startCourseBtn');
                    console.log('startCourseBtn :', startCourseBtn);
                    const userProgress = await fetchUserProgress(userId);
                    console.log('userProgress lenght : ', userProgress[0]);
                    startCourseBtn.style.display = 'block';
                    startCourseBtn.innerText = Object.keys(userProgress).length > 0 ? 'Continue Course' : 'Start Course';
                    toggleAuthDisplay(user);
                    console.log('current user', user ? user.email : null);
                    // Display lessons based on progress
                    await displayLessons(userId, userProgress);
                }
                else {
                    profileIcon.style.display = 'none';
                    window.location.href = 'index.html';
                }
            });

            document.getElementById('startCourseBtn').addEventListener('click', async () => {
                const courseOverview = document.getElementById('courseOverview');
                const lessonsContainer = document.getElementById('lessonsContainer');
                courseOverview.style.display = 'none';
                lessonsContainer.style.marginTop = '220px';
                document.getElementById('lessonsContainer').style.display = 'flex'; // Show lessons container
            });

           

            const displayLessons = async (userId, userProgress) => {
                window.scrollTo(0, 0);
                const lessonsContainer = document.getElementById('lessonsContainer');
                lessonsContainer.innerHTML = ""; // Clear previous content
                console.log('displayLessons userId', userId);


                try {
                    // Fetch current user data from Firestore
                    const userRef = doc(db, 'users', userId);
                    const userSnapshot = await getDoc(userRef);

                    if (!userSnapshot.exists()) {
                        console.error('User not found');
                        return;
                    }

                    const userData = userSnapshot.data();
                    const isAdmin = userData.role === 'admin';
                    console.log('User role:', userData.role);

                    // Fetch lessons
                    const lessonsRef = collection(db, 'Courses', 'SQL', 'lessons');
                    const lessonsSnapshot = await getDocs(lessonsRef);

                    const lessons = lessonsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => a.lessonNumber - b.lessonNumber); // Sort by 'lessonNumber'

                    console.log('lessonDocs', lessons);

                    // Determine the index of the next lesson if not admin
                    let currentLessonIndex = isAdmin ? -1 : lessons.findIndex(lesson => !userProgress[lesson.id]);
                    console.log('currentLessonIndex', currentLessonIndex);

                    if (lessons.length > 0) {
                        lessons.forEach((lesson, index) => {
                            const { id: lessonId, title, lessonNumber } = lesson;
                            const lessonElement = document.createElement('div');
                            lessonElement.classList.add('lesson');

                            if (userProgress[lessonId]) {
                                const marks = userProgress[lessonId].marks || 0;
                                lessonElement.innerHTML = `
                        <div class="card shadow-sm h-100" style="border-radius: 10px;">
                            <div class="card-body">
                                <h5 class="card-title" style="font-weight: bold; color: #28a745;">
                                    Lesson Number : ${lessonNumber}<br/>Title : ${title} <br/> (Marks: ${marks}/10)<br/> Status : Completed ✅
                                </h5>
                                <button class="review-quiz" style="border-radius: 5px;" data-lesson="${lessonId}">
                                    Review a quiz 
                                </button>
                            </div>
                        </div>
                    `;
                                lessonElement.querySelector('.review-quiz').addEventListener('click', () => {
                                    displayQuizReview(lessonId, userSnapshot.id);
                                });

                            } else if (index === currentLessonIndex || isAdmin) {
                                // Current lesson - show an active button with special styling
                                lessonElement.innerHTML = `
                        <div class="card shadow-sm h-100" style="border-radius: 10px;">
                            <div class="card-body">
                                <h5 class="card-title" style="font-weight: bold; color: #0E3D57;">
                                    Lesson ${lessonNumber}: ${title}
                                </h5>
                                <button class="start-lesson" style="border-radius: 20px; background-color: #0E3D57; color:#fff;" data-lesson="${lessonId}">
                                    Start Lesson
                                </button>
                            </div>
                        </div>
                    `;
                                handleLessonProgress(userSnapshot.id, lessonElement, lessonId);

                            } else {
                                // Future lesson - disabled button
                                lessonElement.innerHTML = `
                        <div class="card shadow-sm h-100" style="border-radius: 10px;">
                            <div class="card-body">
                                <h5 class="card-title" style="font-weight: bold; color: #0E3D57;">
                                    Lesson ${lessonNumber}: ${title}
                                </h5>
                                <button class="start-lesson btn btn-secondary" style="border-radius: 20px;" data-lesson="${lessonId}" disabled>
                                    Locked
                                </button>
                            </div>
                        </div>
                    `;
                            }
                            lessonsContainer.appendChild(lessonElement);
                        });
                    } else {
                        lessonsContainer.innerHTML = "<p>All lessons completed!</p>";
                    }
                } catch (error) {
                    console.error("Error fetching user or lessons data:", error);
                }
            };


            // Function to handle lesson progress
            const handleLessonProgress = async (userId, lessonElement, lessonId) => {
                const lessonsContainer = document.getElementById('lessonsContainer');
                const courseOverview = document.getElementById('courseOverview');
                const startLessonButton = lessonElement.querySelector('.start-lesson');
                const lessonText = document.createElement('div');

                startLessonButton.addEventListener('click', async () => {

                    startLessonButton.disabled = true;
                    // const lessonsContainer = document.getElementById('lessonsContainer');
                    // lessonElement.style.display = "none";
                    lessonsContainer.style.display = "flex";
                    console.log(' start lesson cliked');

                    try {
                        // Fetch the full lesson content from Firestore using lessonId
                        const lessonRef = doc(db, `Courses/SQL/lessons/${lessonId}`);
                        const lessonSnapshot = await getDoc(lessonRef);

                        if (lessonSnapshot.exists()) {
                            const lessonData = lessonSnapshot.data();
                            // console.log('lessonData', lessonData);
                            const lessonContent = lessonData.textContent || "<p>No content available for this lesson.</p>";
                            const videoUrl = lessonData.videoUrl && lessonData.videoUrl !== ''
                                ? `<div class="video-container" style="position: relative; padding-top: 56.25%; margin-top: 15px;">
                            <iframe 
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                src="https://www.youtube.com/embed/${getYouTubeVideoId(lessonData.videoUrl)}"
                                title="YouTube video player" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        </div>`
                                : "<p style='text-align: center; color: grey;'>Video not available for this lesson.</p>";

                            lessonText.classList.add('lessonContent');
                            lessonText.innerHTML = `
                    <div class="card shadow-sm h-100" style="border-radius: 10px;">
                        <div class="card-bodyv">
                            ${lessonContent} <!-- Use lesson content or placeholder message -->
                            ${videoUrl} <!-- Use video element or placeholder message -->
                            <button class="take-quiz" style="border-radius: 10px; margin-top: 15px;" data-lesson="${lessonId}">
                                Take a quiz
                            </button>
                        </div>
                    </div>
                `;

                            lessonsContainer.appendChild(lessonText);
                            setTimeout(() => {
                                const containerOffset = lessonText.getBoundingClientRect().top + window.pageYOffset;
                                const offset = 50; // Adjust this value for how far above the element you want to scroll

                                window.scrollTo({
                                    top: containerOffset - offset,
                                    behavior: 'smooth'
                                });
                            }, 0);
                            // Handle quiz button click
                            const takeQuizButton = lessonText.querySelector('.take-quiz');
                            if (takeQuizButton) {
                                takeQuizButton.addEventListener('click', async () => {
                                    takeQuizButton.disabled = true;

                                    try {
                                        const userProgress = await fetchUserProgress(userId);
                                        console.log('quiz try clicked');
                                        const quizQuestions = [];
                                        const quizRef = collection(db, `Courses/SQL/lessons/${lessonId}/quiz/quizDoc/questions`);
                                        const querySnapshot = await getDocs(quizRef);
                                        querySnapshot.forEach((doc) => {
                                            quizQuestions.push({ id: doc.id, ...doc.data() });
                                        });

                                        // Check if the quiz form already exists
                                        if (!document.getElementById('quizForm')) {
                                            // Display quiz form only if it doesn't already exist
                                            displayQuiz(quizQuestions, userId, lessonId, userProgress);
                                        } else {
                                            console.log("Quiz form already displayed.");
                                        }

                                    } catch (error) {
                                        console.error("Error fetching quiz questions: ", error);
                                        toastr.error("Error fetching quiz questions");
                                    }

                                });
                            } else {
                                console.log(`Quiz button for lesson ${lessonId} not found.`);
                                toastr.error(`Quiz button for lesson not found.`);
                            }
                        } else {
                            console.log(`Lesson data for ${lessonId} not found.`);
                            toastr.error(`Lesson data Not Found.`);
                        }

                    } catch (error) {
                        console.log("Error fetching lesson content: ", error);
                        toastr.error("Error Fetching Lesson Content");
                    }
                    lessonsContainer.appendChild(lessonText);

                });
            };

            // Function to display quiz questions (you can customize this for your UI)
            const displayQuiz = (quizQuestions, userId, lessonId, userProgress) => {
                const quizContainer = document.createElement('form');
                quizContainer.classList.add('quizContainer');
                quizContainer.id = 'quizForm';
                // Loop through each question
                quizQuestions.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('quizQuestion');

                    // Loop through the answers object (instead of array) to display answer options
                    const answerOptions = Object.keys(question.answers).map((key) => {
                        const answer = question.answers[key];
                        return `
                <label>
                    <input type="radio" name="question${index}" value="${key}">
                    ${answer.answer}
                </label>
            `;
                    }).join('');

                    // Set up the question and answer options
                    questionElement.innerHTML = `
            <p>${index + 1}. ${question.questionText}</p>
            ${answerOptions}
        `;
                    quizContainer.appendChild(questionElement);
                });

                // Add a submit button
                quizContainer.innerHTML += `<button type="submit">Submit Quiz</button> `;

                // Append quiz form to the container
                document.getElementById('lessonsContainer').appendChild(quizContainer);
                setTimeout(() => {
                    const containerOffset = quizContainer.getBoundingClientRect().top + window.pageYOffset;
                    const offset = 50; // Adjust this value for how far above the element you want to scroll

                    window.scrollTo({
                        top: containerOffset - offset,
                        behavior: 'smooth'
                    });
                }, 0);

                // Event listener for form submission
                quizContainer.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Prevent default form submission

                    const userAnswers = quizQuestions.map((question, index) => {
                        const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                        return selectedOption ? selectedOption.value : null; // Store the selected answer key (like "a1", "a2")
                    });
                    console.log('userAnswers', userAnswers);

                    // Check if all questions are answered
                    const unansweredQuestions = userAnswers.some(answer => answer === null);
                    if (unansweredQuestions) {
                        toastr.warning("Please answer all the questions before submitting the quiz."); // Display warning
                        return; // Stop submission if there are unanswered questions
                    }

                    toastr.success('Quiz Submitted Successfully');
                    // Compare user's answers with correct answers and store the result
                    const result = quizQuestions.map((question, index) => {
                        const userAnswerKey = userAnswers[index];
                        const isCorrect = userAnswerKey !== null && question.answers[userAnswerKey].isCorrect;
                        return {
                            questionId: question.id,
                            userAnswer: userAnswerKey,
                            isCorrect
                        };
                    });

                    console.log('result', result);
                    // Save the user's progress and results in Firestore (your Firestore function should handle the storage)
                    await saveQuizResult(userId, lessonId, result);
                    const userProgress = await fetchUserProgress(userId);
                    displayLessons(userId, userProgress);
                });
            };
            // Firestore save function
            const saveQuizResult = async (userId, lessonId, result) => {
                console.log('userId:', userId);
                console.log('lessonId:', lessonId);
                console.log('result:', result);

                try {
                    const userProgressRef = doc(db, `users/${userId}`); // Reference to the user document
                    await setDoc(userProgressRef, {
                        quizzes: {
                            [lessonId]: { // Store the quiz data under the lessonId
                                marks: result.filter(item => item.isCorrect).length, // Calculate marks based on correct answers
                                quizResult: result // Save the full quiz result
                            }
                        }
                    }, { merge: true }); // Merge to avoid overwriting other fields in the user document
                } catch (error) {
                    console.error('Error saving quiz result:', error);
                }
            };

            // Function to display the quiz review
            const displayQuizReview = async (lessonId, userId) => {
                // Fetch user's answers and quiz questions
                const userAnswers = await fetchUserAnswers(userId, lessonId);
                const quizQuestions = await fetchQuizQuestions(lessonId);

                const reviewContainer = document.createElement('div');
                reviewContainer.classList.add('quizReview');

                let totalMarks = 0; // To calculate the total score

                // Loop through each question
                quizQuestions.forEach((question, index) => {
                    const userAnswerIndex = userAnswers[index]?.userAnswer; // User's chosen answer index
                    const isCorrect = userAnswers[index]?.isCorrect; // Whether user's answer is correct

                    console.log(`Question ${index + 1}:`);
                    console.log(`User Answer Index: ${userAnswerIndex}`);
                    console.log(`Is Correct: ${isCorrect}`);

                    const reviewElement = document.createElement('div');
                    reviewElement.classList.add('quizQuestionReview');

                    reviewElement.innerHTML = `<p><strong>${index + 1}. ${question.questionText}</strong></p>`;

                    question.answers.forEach((answer, idx) => {
                        let answerColor = 'black'; // Default color for all answers

                        // Check if this is the user's selected answer
                        if (idx === parseInt(userAnswerIndex)) {
                            // If the answer is correct, color it green; if incorrect, color it red
                            answerColor = isCorrect ? 'green' : 'red';
                        }


                        console.log(`Answer ${idx}: ${answer.answer}, Color: ${answerColor}`);

                        // Display the answer option with the right color
                        reviewElement.innerHTML += `
                <p style="color: ${answerColor};">
                    ${answer.answer}
                </p>
            `;
                    });

                    // If the user's answer is incorrect, show the correct answer too
                    if (!isCorrect) {
                        const correctAnswer = question.answers.find(answer => answer.isCorrect);
                        reviewElement.innerHTML += `
                <p style="color: green;">
                    Correct Answer: ${correctAnswer.answer}
                </p>
            `;
                    }

                    if (isCorrect) {
                        totalMarks++;
                    }

                    reviewContainer.appendChild(reviewElement);
                });

                // Create a wrapper for total marks and Go Back button
                const resultsWrapper = document.createElement('div');
                resultsWrapper.style.display = 'flex';
                resultsWrapper.style.justifyContent = 'space-between';
                resultsWrapper.style.alignItems = 'center';

                const totalMarksElement = document.createElement('p');
                totalMarksElement.innerHTML = `<strong>Total Marks: ${totalMarks} / ${quizQuestions.length}</strong>`;

                // Go Back Button

                const btnStyle = {
                    background: '#0E3D57',
                    color: '#fff',
                    padding: '8px 15px',
                    border: 'none',
                    borderRadius: '5px', // Fixing the typo from CSS
                    cursor: 'pointer',
                    transition: 'background 0.3s ease',
                    display: 'block',
                    width: '30%',
                    textAlign: 'center', // Fixing the typo from CSS
                    marginBottom: '3px',
                    marginLeft: 'auto'
                };

                // For the hover effect, you'll handle this separately in JavaScript
                const btnHoverStyle = {
                    backgroundColor: '#65A9C2',
                    color: '#fff',
                };

                const goBackButton = document.createElement('button');
                goBackButton.textContent = 'Go Back';
                for (const property in btnStyle) {
                    goBackButton.style[property] = btnStyle[property];
                }

                // Add event listeners for hover effect
                goBackButton.addEventListener('mouseover', () => {
                    for (const property in btnHoverStyle) {
                        goBackButton.style[property] = btnHoverStyle[property];
                    }
                });

                goBackButton.addEventListener('mouseout', () => {
                    for (const property in btnStyle) {
                        goBackButton.style[property] = btnStyle[property];
                    }
                });

                goBackButton.addEventListener('click', async () => {
                    // Go back logic (e.g., navigate to lesson page or previous quiz page)
                    console.log('Go back button clicked');
                    // You can use window.history.back() or any navigation function to go back
                    const userProgress = await fetchUserProgress(userId);
                    displayLessons(userId, userProgress);
                    // window.history.back();
                });

                resultsWrapper.appendChild(totalMarksElement);
                resultsWrapper.appendChild(goBackButton);

                reviewContainer.appendChild(resultsWrapper);

                document.getElementById('lessonsContainer').innerHTML = '';
                document.getElementById('lessonsContainer').appendChild(reviewContainer);
            };

            // Function to fetch user answers from Firestore
            const fetchUserAnswers = async (userId, lessonId) => {
                const userDocRef = doc(db, `users/${userId}`);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const quizzes = userData.quizzes || {}; // Get the quizzes map (or default to an empty object)
                    const lessonQuiz = quizzes[lessonId]; // Access the specific lesson's quiz data

                    if (lessonQuiz) {
                        return lessonQuiz.quizResult; // Return the quiz result for this lesson
                    }
                }

                return []; // Return an empty array if no quiz data exists for the lesson
            };


            // Function to fetch quiz questions from Firestore
            const fetchQuizQuestions = async (lessonId) => {
                const questionsRef = collection(db, 'Courses', 'SQL', 'lessons', lessonId, 'quiz', 'quizDoc', 'questions');
                const questionsSnapshot = await getDocs(questionsRef);

                return questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            };


        });

        // Function to fetch the user's progress from Firestore
        const fetchUserProgress = async (userId) => {
            try {
                // Reference to the user's document in the 'users' collection
                const userDocRef = doc(db, 'users', userId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    // If the user document exists, return the progress field from the document
                    const userData = userDocSnap.data();
                    return userData.quizzes || {}; // Return the progress object, or an empty object if it doesn't exist
                } else {
                    console.error(`No such user document for userId: ${userId}`);
                    return {};
                }
            } catch (error) {
                console.error("Error fetching user progress:", error);
                return {};
            }


        };

        // Click anywhere to close the profile section
        document.addEventListener('click', (event) => {
            const isClickInsideProfile = profileSection.contains(event.target) || profileIcon.contains(event.target);
            if (!isClickInsideProfile) {
                profileSection.style.display = 'none'; // Hide the profile section
            }
        });

    </script>

</head>

<body>
    <header class="header">

        <!-- Top Bar -->
        <div class="top_bar">
            <div class="top_bar_container">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <div class="top_bar_content d-flex flex-row align-items-center justify-content-start">
                                <ul class="top_bar_contact_list">
                                    <li>
                                        <div id="BtnQuestion" class="BtnQuestionC">Have any questions?</div>
                                    </li>
                                    <li>
                                        <div>Albaiti.ahmed@live.iium.edu.my</div>
                                    </li>
                                    <li>
                                        <div>mazin.muhammed@live.iium.edu.my</div>
                                    </li>
                                </ul>
                                <div class="top_bar_login ml-auto" id="authContainer">
                                    <ul id="authLinks" style="list-style: none; margin: 0; padding: 0; display: flex;">
                                        <li style="margin-right: 1px;"><a href="signUp.html"
                                                style="text-decoration: none; color: #fff;">Register</a></li>
                                        <li><a href="login.html" style="text-decoration: none; color: #fff;">Login</a>
                                        </li>
                                    </ul>
                                    <div id="profileContainer" style="position: relative; display: inline-block;">
                                        <i class="fas fa-user-alt" id="profileIcon"
                                            style="font-size: 24px; color: #fff; cursor: pointer; margin-right: 20px; transition: color 0.3s ease;"></i>

                                        <div id="profileSection" style="display: none; 
                                            position: absolute; 
                                            right: 0; 
                                            top: 35px; 
                                            background-color: #fff; 
                                            border: 1px solid #ddd; 
                                            padding: 20px; 
                                            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); 
                                            border-radius: 10px; 
                                            z-index: 100; 
                                            width: 280px; 
                                            transition: all 0.3s ease;">
                                            <span id="userName"
                                                style="display: block; color: #0E3D57; margin-bottom: 10px; font-size: 0.9rem;">Name
                                                :</span>
                                            <span id="userEmail"
                                                style="display: block; color: #0E3D57; margin-bottom: 20px; font-size: 0.9rem;">Email
                                                :</span>

                                            <button id="myProgressButton" class="myProgressButton">
                                                View My Progress
                                            </button>

                                            <button id="signOutButton" class="signOutButton">
                                                Sign Out
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header Content -->
        <div class="header_container">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <div class="header_content d-flex flex-row align-items-center justify-content-start">
                            <div class="logo_container">
                                <a href="#">
                                    <div class="logo_content d-flex flex-row align-items-end justify-content-start">
                                        <div class="logo_img"><img src="images/assets//DataED_logo.jpg" alt=""
                                                style="width: 80px;"></div>
                                    </div>
                                </a>
                            </div>
                            <nav class="main_nav_contaner ml-auto">
                                <ul class="main_nav">
                                    <li><a href="index.html">home</a></li>
                                    <li><a href="about.html">about us</a></li>
                                    <li class="active"><a href="courses.html">lessons</a></li>
                                    <!-- <li><a href="news.html">news</a></li> -->
                                    <li><a href="contact.html"></a></li>
                                </ul>
                                <!-- <div class="search_button"><i class="fa fa-search" aria-hidden="true"></i></div> -->

                                <!-- Hamburger -->

                                <div class="hamburger menu_mm">
                                    <i class="fa fa-bars menu_mm" aria-hidden="true"></i>
                                </div>
                            </nav>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header Search Panel -->
        <div class="header_search_container">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <div class="header_search_content d-flex flex-row align-items-center justify-content-end">
                            <form action="#" class="header_search_form">
                                <input type="search" class="search_input" placeholder="Search" required="required">
                                <button
                                    class="header_search_button d-flex flex-column align-items-center justify-content-center">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- SQL Page Content -->
    <div class="sql-content container my-5">

        <!-- Overview Section -->
        <div id="courseOverview" class="overview-section text-center mb-5"
            style="max-width: 800px; margin: 200px auto 0 auto;">
            <p style="font-size: 1.2rem; color: #555;">
                This course provides a comprehensive foundation in SQL databases, covering the essential concepts needed
                to
                interact with and manage data. Designed for beginners, the course consists of 6 lessons that will guide
                you
                through the basics of SQL step-by-step.
            </p>
            <button id="startCourseBtn" class="start-course" style="border-radius: 20px; display: none;"></button>
        </div>

        <!-- Lessons Container -->
        <div id="lessonsContainer" style="display: none;">

        </div>
    </div>
    <!-- End of SQL Page Content -->
    <!-- Footer -->

    <footer class="footer">
        <div class="container">
            <div class="row">
                <!-- About -->
                <div class="col-lg-3 footer_col">
                    <div class="footer_about">
                        <div class="logo_container">
                            <a href="index.html">
                                <div class="logo_content d-flex flex-row align-items-end justify-content-start">
                                    <div class="logo_img"><img src="images/assets/DataED_logo.jpg" alt=""
                                            style="width: 80px;"></div>
                                </div>
                            </a>
                        </div>
                        <div class="footer_about_text">
                            <p>Welcome to our website. We are dedicated to providing quality content and exceptional
                                service to our users. Your feedback is valuable to us as we strive for continuous
                                improvement.</p>
                        </div>
                        <div class="footer_social">
                            <ul>
                                <li><a href="https://plus.google.com/" target="_blank" rel="noopener noreferrer"><i
                                            class="fab fa-google-plus" aria-hidden="true"></i></a></li>
                                <li><a href="https://www.pinterest.com/" target="_blank" rel="noopener noreferrer"><i
                                            class="fab fa-pinterest" aria-hidden="true"></i></a></li>
                                <li><a href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer"><i
                                            class="fab fa-facebook" aria-hidden="true"></i></a></li>
                                <li><a href="https://x.com/" target="_blank" rel="noopener noreferrer"><i
                                            class="fab fa-twitter" aria-hidden="true"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 footer_col">
                    <div class="footer_links">
                        <div class="footer_title">Quick menu</div>
                        <ul class="footer_list">
                            <li><a href="index.html">Home</a></li>
                            <li><a href="about.html">About us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-3 footer_col">
                    <div class="footer_contact">
                        <div class="footer_title">Contact Us</div>
                        <div class="footer_contact_info">
                            <div class="footer_contact_item">
                                <div class="footer_contact_title">Address:</div>
                                <div class="footer_contact_line">Jalan Gombak, 53100 Kuala Lumpur,
                                    Malaysia</div>
                            </div>
                            <div class="footer_contact_item">
                                <div class="footer_contact_title">Phone:</div>
                                <div class="footer_contact_line">+966 532666580</div>
                            </div>
                            <div class="footer_contact_item">
                                <div class="footer_contact_title">Email:</div>
                                <div class="footer_contact_line">Albaiti.ahmed@live.iium.edu.my</div>
                                <div class="footer_contact_line">mazin.muhammed@live.iium.edu.my</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="styles/bootstrap4/popper.js"></script>
    <script src="styles/bootstrap4/bootstrap.min.js"></script>
    <script src="plugins/greensock/TweenMax.min.js"></script>
    <script src="plugins/greensock/TimelineMax.min.js"></script>
    <script src="plugins/scrollmagic/ScrollMagic.min.js"></script>
    <script src="plugins/greensock/animation.gsap.min.js"></script>
    <script src="plugins/greensock/ScrollToPlugin.min.js"></script>
    <script src="plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="plugins/easing/easing.js"></script>
    <script src="plugins/video-js/video.min.js"></script>
    <script src="plugins/video-js/Youtube.min.js"></script>
    <script src="plugins/parallax-js-master/parallax.min.js"></script>
    <script src="js/custom.js"></script>
</body>

</html>